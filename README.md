# Вариант A

## Исходные данные

Для анализа были выбраны **2 видео**:
- первое — один человек идёт прямо;
- второе — группа людей танцует.

Основные эксперименты проводятся **на видео с танцами**.

<img width="304" height="193" alt="image" src="https://github.com/user-attachments/assets/1f6a31dd-b65c-4f04-b578-1d22a8fdfdc9" />

**Характеристика видео:**  
`(1920, 1080, 30.0, 750, 25.0)`

<img width="305" height="193" alt="image" src="https://github.com/user-attachments/assets/671e950a-fb12-4fa7-b91d-67d6d59b9fb1" />

**Характеристика видео:**  
`(1920, 1080, 30.0, 402, 13.4)`

Оба видео в формате **Full HD**.  
Для упрощения вычислений выполняется **ресайз до 640×360**, встроенный в функцию чтения кадров.

Так как в видео присутствуют люди, используются **две модели**:
- **DeepLabv3** — универсальная модель семантической сегментации  
- **MediaPipe Selfie Segmentation** — специализированная модель (человек vs фон)

---

## DeepLabv3

В качестве базовой нейросетевой модели выбрана **DeepLabv3**, классическая архитектура семантической сегментации, возвращающая вероятностные карты классов.

### Базовый сценарий

<img width="429" height="335" alt="image" src="https://github.com/user-attachments/assets/b532a342-c397-4d0f-95ba-948371c2a2bb" />

**Метрики (до сглаживания):**
- Mean IoU: `0.8750319525266613`
- 10-й перцентиль IoU: `0.7943104900430423`
- IoU min: `0.6419104549708662`
- IoU max: `0.9983069704445412`

**Худшие кадры (t, IoU):**
- t=1354 → 0.642  
- t=1103 → 0.685  
- t=1357 → 0.685  
- t=1353 → 0.686  
- t=1352 → 0.690  

Базовая сегментация без временного сглаживания в целом стабильна, однако наблюдаются локальные резкие провалы между соседними кадрами, визуально проявляющиеся как **мерцание маски**.  
**Цель — сгладить эти провалы.**

---

### EMA-сглаживание

Начальное значение: **alpha = 0.6**

<img width="425" height="335" alt="image" src="https://github.com/user-attachments/assets/4988fd97-ac05-4cd0-8f21-6779315a4302" />

**Метрики:**
- Mean IoU до: `0.8750319525266613`
- Mean IoU после: `0.8938654272125326`
- 10-й перцентиль до: `0.7943104900430423`
- 10-й перцентиль после: `0.835456755693124`

EMA повышает временную стабильность сегментации, особенно в наиболее нестабильных участках видео.

#### Подбор параметра alpha

- `alpha = 0.3` → mean IoU `0.9123`, p10 `0.8757`
- `alpha = 0.5` → mean IoU `0.8960`, p10 `0.8427`
- `alpha = 0.7` → mean IoU `0.8841`, p10 `0.8157`
- `alpha = 0.85` → mean IoU `0.8771`, p10 `0.7997`

**Лучший результат:** `alpha = 0.3`

**Интерпретация:**  
- Большие значения α усиливают реакцию на текущий кадр и повышают мерцание.
- Малые α обеспечивают устойчивость, но могут вызывать задержку маски.
- **Оптимальным оказалось значение α = 0.3**, обеспечивающее наилучший баланс.

<img width="427" height="336" alt="image" src="https://github.com/user-attachments/assets/44d493d5-9e54-420b-b64e-cf35de1f2bfd" />

**Итоговые метрики:**
- Mean IoU: `0.915215159742111`
- 10-й перцентиль: `0.8792121191462936`

<img width="586" height="497" alt="image" src="https://github.com/user-attachments/assets/e3662846-1d4f-44a3-90ce-6236285ae335" />

EMA-сглаживание существенно снижает мерцание маски, однако визуально покадровые отличия не всегда бросаются в глаза.

---

### Медианное сглаживание

Подбор параметров:

- `window = 3` → mean `0.8979`, p10 `0.8306`
- `window = 5` → mean `0.9130`, p10 `0.8588`
- `window = 7` → mean `0.9233`, p10 `0.8742`
- `window = 9` → mean `0.9309`, p10 `0.8878`
- `window = 11` → mean `0.9373`, p10 `0.8976`

Лучшие метрики при `window = 11`, но визуально наблюдается **запаздывание маски**.

<img width="433" height="337" alt="image" src="https://github.com/user-attachments/assets/be022598-614c-42ed-b0c5-d66b2517fb76" />

<img width="964" height="527" alt="image" src="https://github.com/user-attachments/assets/01b3e0da-a681-4841-87bb-22276be8a9c8" />

Медианное сглаживание сильнее подавляет шум, но за счёт лагов.

---

## MediaPipe Selfie Segmentation

Модель специализирована под задачу **человек vs фон**.

Начальное значение: **alpha = 0.3**

<img width="467" height="346" alt="image" src="https://github.com/user-attachments/assets/215288f1-f7f7-46a5-af0e-589480018cf3" />

**Метрики:**
- RAW: mean `0.6089`, p10 `0.1599`
- EMA: mean `0.7555`, p10 `0.4677`

### Подбор alpha

- `alpha = 0.1` → mean `0.8435`, p10 `0.6742`
- `alpha = 0.2` → mean `0.7911`, p10 `0.5344`
- `alpha = 0.3` → mean `0.7555`, p10 `0.4677`
- `alpha = 0.5` → mean `0.6971`, p10 `0.3593`
- `alpha = 0.7` → mean `0.6589`, p10 `0.2653`

Оптимально: **alpha = 0.1**

Для MediaPipe требуется **более сильное сглаживание (α = 0.1)**, что указывает на высокий уровень шума в покадровых предсказаниях.

<img width="468" height="348" alt="image" src="https://github.com/user-attachments/assets/e7e1f10b-9f83-4bbb-8cca-5ef5350e664d" />

<img width="735" height="552" alt="image" src="https://github.com/user-attachments/assets/19e16f68-4705-4eb9-9b40-4ac873f5f41c" />

MediaPipe заметно уступает DeepLabv3 по стабильности.

---

### Более простое видео (человек идёт)

<img width="424" height="339" alt="image" src="https://github.com/user-attachments/assets/bed2d7a7-b7e2-485d-a32d-561cb493f15b" />

- RAW: mean `0.7745`, p10 `0.4306`
- EMA: mean `0.9231`, p10 `0.8623`
- MED11: mean `0.9229`, p10 `0.88`

<img width="965" height="474" alt="image" src="https://github.com/user-attachments/assets/f0e10bbe-b03a-4486-8c83-f6bc0ca18e12" />

На простых видео MediaPipe работает значительно лучше, однако сглаженные маски запаздывают.

---

## Итоговый пайплайн

1. Читает видео и загружает его в память как список кадров (с уменьшением ширины до 640).
2. Для каждого кадра применяет DeepLabv3 и извлекает вероятностную карту класса `person` (class_id = 15).
3. Подбирает параметр EMA alpha по средней и 10-й перцентиль IoU между соседними кадрами.
4. Повторно обрабатывает видео с оптимальным alpha, применяя EMA-сглаживание.
5. Накладывает сглаженную маску на кадры и сохраняет итоговое видео.

## Общий вывод

- **DeepLabv3 + EMA (α = 0.3)** показал наилучшее качество и стабильность сегментации.
- **MediaPipe** требует более сильного сглаживания и в целом уступает по качеству.
- EMA обеспечивает оптимальный компромисс между устойчивостью и адаптивностью.
- Медианное сглаживание эффективно подавляет шум, но вызывает задержку масок.















