# HW2 — Видеоаналитика  
## Вариант A: Временная стабилизация сегментации человека на видео

В данной работе рассматривается задача **уменьшения временного мерцания масок семантической сегментации** на видео.  
Цель работы — повысить **временную стабильность сегментации человека** за счёт применения методов сглаживания во времени и количественно оценить эффект с помощью метрики IoU между соседними кадрами.

---

## Исходные данные

Для экспериментов были выбраны два видео:

1. Видео с **одним человеком**, идущим прямо.
2. Видео с **группой людей, танцующих**.

Основные эксперименты проводились **на видео с танцами**, поскольку оно:
- содержит быстрые движения,
- включает несколько объектов одного класса,
- является более сложным с точки зрения временной стабильности сегментации.

---

### Видео 1

<img src="https://github.com/user-attachments/assets/1f6a31dd-b65c-4f04-b578-1d22a8fdfdc9" width="350"/>

**Характеристики видео:**  
`1920 × 1080, 30 FPS, 750 кадров, 25.0 сек`

---

### Видео 2

<img src="https://github.com/user-attachments/assets/671e950a-fb12-4fa7-b91d-67d6d59b9fb1" width="350"/>

**Характеристики видео:**  
`1920 × 1080, 30 FPS, 402 кадра, 13.4 сек`

---

Оба видео имеют формат **Full HD**.  
Для ускорения вычислений был выполнен **ресайз кадров до 640×360**, встроенный непосредственно в этап чтения видео.

---

## Выбор моделей

Для задачи сегментации людей были использованы две модели:

- **DeepLabv3** — универсальная модель семантической сегментации, возвращающая вероятностные карты классов.
- **MediaPipe Selfie Segmentation** — специализированная модель для задачи *человек vs фон*, оптимизированная под real-time применение.

---

# DeepLabv3

## Базовый сценарий (без временного сглаживания)

<img src="https://github.com/user-attachments/assets/b532a342-c397-4d0f-95ba-948371c2a2bb" width="450"/>

Для оценки временной стабильности использовалась метрика **IoU(t, t+1)** — пересечение масок соседних кадров.

**Метрики стабильности:**

- Средний IoU: `0.875`
- 10-й перцентиль IoU: `0.794`
- Минимальный IoU: `0.642`
- Максимальный IoU: `0.998`

### Наихудшие по стабильности кадры

| Номер кадра (t) | IoU(t, t+1) |
|----------------:|------------:|
| 1354 | 0.642 |
| 1103 | 0.685 |
| 1357 | 0.685 |
| 1353 | 0.686 |
| 1352 | 0.690 |

**Вывод:**  
Покадровая сегментация в целом стабильна, однако присутствуют локальные резкие изменения маски между соседними кадрами.  
Именно эти эпизоды формируют визуально заметное **мерцание**, которое необходимо подавить.

---

## EMA-сглаживание (DeepLabv3)

Для уменьшения мерцания было применено **экспоненциальное скользящее среднее (EMA)** по вероятностным картам во времени.

### Подбор параметра α

Для выбора оптимального параметра сглаживания был выполнен перебор значений α.  
Качество оценивалось по метрике **IoU(t, t+1)**.

| α (alpha) | Mean IoU | 10-й перцентиль IoU |
|----------:|---------:|--------------------:|
| **0.30** | **0.9123** | **0.8757** |
| 0.50 | 0.8960 | 0.8427 |
| 0.70 | 0.8841 | 0.8157 |
| 0.85 | 0.8771 | 0.7997 |

**Интерпретация:**  
- Большие значения α усиливают реакцию на текущий кадр и повышают мерцание.
- Малые α обеспечивают устойчивость, но могут вызывать задержку маски.
- **Оптимальным оказалось значение α = 0.3**, обеспечивающее наилучший баланс.

---

### Итоговые метрики EMA (α = 0.3)

- Средний IoU до: `0.875`
- Средний IoU после: `0.915`
- 10-й перцентиль до: `0.794`
- 10-й перцентиль после: `0.879`

<img src="https://github.com/user-attachments/assets/e3662846-1d4f-44a3-90ce-6236285ae335" width="600"/>

**Вывод:**  
EMA-сглаживание существенно повышает временную стабильность сегментации и эффективно снижает мерцание масок.

---

## Медианное сглаживание (DeepLabv3)

Дополнительно было реализовано **медианное сглаживание бинарных масок** во времени.

### Подбор размера окна

| Размер окна | Mean IoU | 10-й перцентиль IoU |
|------------:|---------:|--------------------:|
| 3 | 0.8979 | 0.8306 |
| 5 | 0.9130 | 0.8588 |
| 7 | 0.9233 | 0.8742 |
| 9 | 0.9309 | 0.8878 |
| **11** | **0.9373** | **0.8976** |

<img src="https://github.com/user-attachments/assets/01b3e0da-a681-4841-87bb-22276be8a9c8" width="800"/>

**Вывод:**  
Медианное сглаживание обеспечивает максимальное подавление мерцания, однако может приводить к заметному **запаздыванию маски** при быстрых движениях.

---

# MediaPipe Selfie Segmentation

MediaPipe — специализированная модель для задачи **человек vs фон**, потенциально менее шумная, чем универсальные архитектуры.

---

## EMA-сглаживание (начальный эксперимент)

| Метод | Mean IoU | 10-й перцентиль IoU |
|------:|---------:|--------------------:|
| RAW | 0.609 | 0.160 |
| EMA (α = 0.3) | 0.755 | 0.468 |

**Вывод:**  
EMA существенно повышает стабильность, однако качество остаётся ниже, чем у DeepLabv3.

---

## Подбор параметра α (MediaPipe)

| α (alpha) | Mean IoU | 10-й перцентиль IoU |
|----------:|---------:|--------------------:|
| **0.10** | **0.8435** | **0.6742** |
| 0.20 | 0.7911 | 0.5344 |
| 0.30 | 0.7555 | 0.4677 |
| 0.50 | 0.6971 | 0.3593 |
| 0.70 | 0.6589 | 0.2653 |

**Вывод:**  
Для MediaPipe требуется **более сильное сглаживание (α = 0.1)**, что указывает на высокий уровень шума в покадровых предсказаниях.

---

## Медианное сглаживание (MediaPipe)

| Метод | Mean IoU | 10-й перцентиль IoU |
|------:|---------:|--------------------:|
| RAW | 0.609 | 0.160 |
| EMA (α = 0.1) | 0.844 | 0.674 |
| MEDIAN (window = 11) | 0.855 | 0.674 |

<img src="https://github.com/user-attachments/assets/aee41e8c-b76c-406e-9283-525e2cf7cdb1" width="800"/>

**Вывод:**  
Медианное сглаживание показывает наивысший средний IoU, однако EMA обеспечивает более адаптивное поведение маски без выраженного запаздывания.

---

## Итоговый пайплайн

1. Чтение видео и загрузка кадров с ресайзом до 640 пикселей по ширине.
2. Сегментация класса *person* с помощью DeepLabv3.
3. Подбор параметра EMA `alpha` по метрике IoU(t, t+1).
4. Применение EMA-сглаживания вероятностных карт во времени.
5. Наложение сглаженной маски и сохранение итогового видео.

---

## Общий вывод

- **DeepLabv3 + EMA** показал наилучшее качество и стабильность сегментации.
- **MediaPipe** требует более сильного сглаживания и в целом уступает по качеству.
- EMA обеспечивает оптимальный компромисс между устойчивостью и адаптивностью.
- Медианное сглаживание эффективно подавляет шум, но вызывает задержку масок.















